{"version":3,"sources":["../../../../../CL0V/actions/student-actions.ts","../../../../../CL0V/.next-internal/server/app/%28dashboard%29/students/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["'use server'\n\nimport db from '@/lib/db';\nimport { Student, Major, Event, Club, Activity } from '@/types/db';\nimport { revalidatePath } from 'next/cache';\n\n// --- HELPER TYPES ---\n// We define this here because the UI usually needs the Major Name, not just the ID\nexport type StudentWithMajor = Student & {\n  majorName: string | null;\n  clubCount: number;\n  activityCount: number;\n  eventCount: number;\n};\n\n// --- READ ---\n\nexport async function getStudents() {\n  // We JOIN with majors to get the readable name (e.g., 'IID') instead of just a number\n  // And we include counts for clubs, activities, and events\n  const students = db.prepare(`\n    SELECT \n      students.*, \n      majors.majorName,\n      (SELECT COUNT(*) FROM clubMemberships WHERE clubMemberships.studentId = students.studentId) as clubCount,\n      (SELECT COUNT(*) FROM registrations WHERE registrations.studentId = students.studentId) as activityCount,\n      (SELECT COUNT(*) FROM eventParticipants WHERE eventParticipants.studentId = students.studentId) as eventCount\n    FROM students \n    LEFT JOIN majors ON students.majorId = majors.majorId\n    ORDER BY students.lastName ASC\n  `).all() as StudentWithMajor[];\n  \n  return students;\n}\n\nexport async function getStudentEvents(studentId: number) {\n  const events = db.prepare(`\n    SELECT e.* \n    FROM events e\n    JOIN eventParticipants ep ON e.eventId = ep.eventId\n    WHERE ep.studentId = ?\n    ORDER BY e.startDate DESC\n  `).all(studentId) as Event[];\n  return events;\n}\n\nexport async function getStudentClubs(studentId: number) {\n  const clubs = db.prepare(`\n    SELECT c.* \n    FROM clubs c\n    JOIN clubMemberships cm ON c.clubId = cm.clubId\n    WHERE cm.studentId = ?\n    ORDER BY c.clubName ASC\n  `).all(studentId) as Club[];\n  return clubs;\n}\n\nexport async function getStudentActivities(studentId: number) {\n  const activities = db.prepare(`\n    SELECT a.* \n    FROM activities a\n    JOIN registrations r ON a.activityId = r.activityId\n    WHERE r.studentId = ?\n    ORDER BY a.startDate DESC\n  `).all(studentId) as Activity[];\n  return activities;\n}\n\nexport async function getTotalActivitiesCount() {\n  const result = db.prepare('SELECT COUNT(*) as count FROM activities').get() as { count: number };\n  return result.count;\n}\n\n// We need this to populate the <Select> dropdown in the Add/Edit form\nexport async function getMajors() {\n  return db.prepare('SELECT * FROM majors ORDER BY majorName ASC').all() as Major[];\n}\n\n// --- CREATE ---\n\nexport async function createStudent(formData: FormData) {\n  const firstName = formData.get('firstName') as string;\n  const lastName = formData.get('lastName') as string;\n  const cne = formData.get('cne') as string;\n  const email = formData.get('email') as string;\n  // Convert string \"1\" to number 1, or null if empty\n  const majorId = formData.get('majorId') ? parseInt(formData.get('majorId') as string) : null;\n\n  try {\n    const stmt = db.prepare(`\n      INSERT INTO students (firstName, lastName, cne, email, majorId)\n      VALUES (@firstName, @lastName, @cne, @email, @majorId)\n    `);\n\n    stmt.run({ firstName, lastName, cne, email, majorId });\n    \n    revalidatePath('/students');\n    return { success: true, message: 'Student registered successfully' };\n  } catch (error: any) {\n    // Handle Unique Constraints (Duplicate CNE or Email)\n    if (error.code === 'SQLITE_CONSTRAINT_UNIQUE') {\n      return { success: false, message: 'Error: Student Code (CNE) or Email already exists.' };\n    }\n    return { success: false, message: error.message };\n  }\n}\n\n// --- UPDATE ---\n\nexport async function updateStudent(studentId: number, formData: FormData) {\n  const firstName = formData.get('firstName') as string;\n  const lastName = formData.get('lastName') as string;\n  const cne = formData.get('cne') as string;\n  const email = formData.get('email') as string;\n  const majorId = formData.get('majorId') ? parseInt(formData.get('majorId') as string) : null;\n\n  try {\n    const stmt = db.prepare(`\n      UPDATE students \n      SET firstName = @firstName, \n          lastName = @lastName, \n          cne = @cne, \n          email = @email, \n          majorId = @majorId\n      WHERE studentId = @studentId\n    `);\n\n    stmt.run({ firstName, lastName, cne, email, majorId, studentId });\n\n    revalidatePath('/students');\n    return { success: true, message: 'Student updated successfully' };\n  } catch (error: any) {\n    if (error.code === 'SQLITE_CONSTRAINT_UNIQUE') {\n      return { success: false, message: 'Error: Student Code or Email is already taken.' };\n    }\n    return { success: false, message: error.message };\n  }\n}\n\n// --- DELETE ---\n\nexport async function deleteStudent(studentId: number) {\n  try {\n    const stmt = db.prepare('DELETE FROM students WHERE studentId = ?');\n    stmt.run(studentId);\n\n    revalidatePath('/students');\n    return { success: true, message: 'Student deleted successfully' };\n  } catch (error: any) {\n    // SQLITE_CONSTRAINT_FOREIGNKEY happens if you try to delete a student \n    // who is arguably an \"Organizer\" of an event or has critical linked data.\n    // (Though usually, ON DELETE CASCADE handles this, it's good to be safe)\n    return { success: false, message: error.message };\n  }\n}","export {logout as '00f497f1f80dfe93943451c06664f4127784cb3b2c'} from 'ACTIONS_MODULE0'\nexport {getStudents as '00d9aceb431ba52b8dbfaaa55a20c815bf08a93a45'} from 'ACTIONS_MODULE1'\nexport {createStudent as '408d8a16dd65eab3a2c2cf1b16b17a43ecc72344cf'} from 'ACTIONS_MODULE1'\nexport {updateStudent as '60e243126889f36f9a9b65c200d76716e49b00f85a'} from 'ACTIONS_MODULE1'\nexport {deleteStudent as '40d1c9713cde1b9aa52074219535e617ab69d29443'} from 'ACTIONS_MODULE1'\nexport {getMajors as '006d9c3697adedd4c6ad617895be501712b2a672c2'} from 'ACTIONS_MODULE1'\nexport {getStudentEvents as '40edd7616a956db407e5876c1e4e2561d131617518'} from 'ACTIONS_MODULE1'\nexport {getStudentClubs as '4038c1fcdff1fc82b5c9e9705f7933053c2019cc58'} from 'ACTIONS_MODULE1'\nexport {getStudentActivities as '40624e09ca7caf0e861c0b570569dc47cbaa64a66e'} from 'ACTIONS_MODULE1'\nexport {getTotalActivitiesCount as '0031492db042306ed80fdd8cc1ae52f1dd5ce12325'} from 'ACTIONS_MODULE1'\n"],"names":[],"mappings":"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"}